<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PetVillage Chat</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="/socket.io/socket.io.js"></script>
    <style>
        .chat-container {
            height: calc(100vh - 200px);
        }

        .messages {
            height: calc(100% - 60px);
            overflow-y: auto;
        }
    </style>
</head>

<body class="bg-gray-100">
    <div class="container mx-auto px-4 py-8">
        <div class="max-w-4xl mx-auto bg-white rounded-lg shadow-lg overflow-hidden">
            <div class="p-4 bg-blue-600 text-white">
                <h1 class="text-2xl font-bold">PetVillage Chat</h1>
                <div id="userInfo" class="text-sm"></div>
                <div id="connectionStatus" class="text-sm"></div>
            </div>

            <div class="flex h-screen">
                <div class="w-1/3 border-r border-gray-200 bg-gray-50">
                    <div class="p-4 border-b border-gray-200">
                        <h2 class="text-lg font-semibold mb-4">Chat Rooms</h2>
                        <button id="createRoomBtn"
                            class="w-full bg-blue-600 text-white py-2 px-4 rounded hover:bg-blue-700 mb-4">
                            Create New Chat
                        </button>
                        <div id="roomList" class="space-y-2"></div>
                    </div>
                </div>

                <div class="flex-1 flex flex-col">
                    <div id="chatArea" class="p-4 flex-1 overflow-y-auto">
                        <div class="flex items-center justify-center h-full text-gray-500">
                            Select a chat room to start messaging
                        </div>
                    </div>

                    <div class="p-4 border-t border-gray-200 bg-white">
                        <form id="messageForm" class="flex space-x-2" style="display: none;">
                            <input type="text" id="messageInput"
                                class="flex-1 border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                                placeholder="Type your message..." autocomplete="off">
                            <button type="submit" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700">
                                Send
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="createRoomModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 w-96">
            <h2 class="text-xl font-bold mb-4">Create New Chat Room</h2>
            <form id="createRoomForm">
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="roomName">
                        Room Name
                    </label>
                    <input type="text" id="roomName" required
                        class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="shopId">
                        Shop ID
                    </label>
                    <input type="text" id="shopId" required value="6829d309e24e6e22db2fcc02"
                        class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                        placeholder="Enter shop ID">
                </div>
                <div class="flex justify-end space-x-2">
                    <button type="button" id="cancelCreateRoom"
                        class="bg-gray-300 text-gray-800 px-4 py-2 rounded hover:bg-gray-400">
                        Cancel
                    </button>
                    <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                        Create
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let socket = null;
        let currentUser = null;
        let currentRoom = null;
        let sentMessageIds = new Set(); // Track sent messages to avoid duplicates

        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative m-4';
            errorDiv.innerHTML = `<span>${message}</span>`;
            document.getElementById('chatArea')?.prepend(errorDiv);
            setTimeout(() => errorDiv.remove(), 5000);
        }

        function appendMessage(message) {
            const chatArea = document.getElementById('chatArea');
            if (!chatArea) return;

            // Avoid appending duplicate messages
            if (message._id && sentMessageIds.has(message._id)) {
                return;
            }
            if (message._id) {
                sentMessageIds.add(message._id);
            }

            // Determine if the message is from the current user
            const isCurrentUser = message.sender?._id === currentUser?._id || message.sender === currentUser?._id || message.senderType === 'System';

            const messageEl = document.createElement('div');
            messageEl.className = `flex ${isCurrentUser ? 'justify-end' : 'justify-start'} mb-4`;
            messageEl.innerHTML = `
                <div class="max-w-xs lg:max-w-md px-4 py-2 rounded-lg ${isCurrentUser ? 'bg-blue-500 text-white' : 'bg-gray-200'}">
                    <div class="font-semibold">${message.sender?.username || message.senderName || message.senderType || 'User'}</div>
                    <div>${message.content}</div>
                    <div class="text-xs ${isCurrentUser ? 'text-blue-100' : 'text-gray-500'} text-right">
                        ${new Date(message.createdAt || message.timestamp || Date.now()).toLocaleString()}
                    </div>
                </div>
            `;
            chatArea.appendChild(messageEl);
            chatArea.scrollTop = chatArea.scrollHeight;
        }

        function updateConnectionStatus(status) {
            const statusElement = document.getElementById('connectionStatus');
            if (!statusElement) return;

            const statusConfig = {
                connected: { text: 'Connected', class: 'text-green-300' },
                disconnected: { text: 'Disconnected', class: 'text-yellow-300' },
                error: { text: 'Connection Error', class: 'text-red-300' },
                default: { text: 'Connecting...', class: 'text-gray-300' }
            };

            const { text, class: statusClass } = statusConfig[status] || statusConfig.default;
            statusElement.textContent = text;
            statusElement.className = `text-sm ${statusClass}`;
        }

        async function checkAuth() {
            const token = localStorage.getItem('token');
            const userData = JSON.parse(localStorage.getItem('user') || '{}');

            if (!token || !userData._id) {
                window.location.href = '/login?redirect=' + encodeURIComponent(window.location.pathname);
                return false;
            }

            try {
                const response = await fetch('/api/auth/me', {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) throw new Error('Session expired');

                currentUser = await response.json();
                localStorage.setItem('user', JSON.stringify(currentUser));
                document.getElementById('userInfo').textContent = `Welcome, ${currentUser.username || currentUser.email}`;
                return true;
            } catch (error) {
                console.error('Auth check failed:', error);
                showError('Session expired. Please log in again.');
                localStorage.removeItem('token');
                localStorage.removeItem('user');
                window.location.href = '/login?redirect=' + encodeURIComponent(window.location.pathname);
                return false;
            }
        }

        function initializeSocket(token) {
            if (socket) {
                socket.disconnect();
            }

            socket = io({
                auth: { token },
                reconnection: true,
                reconnectionAttempts: 5,
                reconnectionDelay: 1000,
                transports: ['websocket']
            });

            socket.on('connect', () => {
                console.log('✅ Connected to chat server');
                socket.emit('authenticate', token);
                if (currentRoom) socket.emit('joinRoom', currentRoom);
                updateConnectionStatus('connected');
            });

            socket.on('authenticated', () => console.log('🔑 Socket authenticated'));

            socket.on('disconnect', (reason) => {
                console.log('🔴 Disconnected:', reason);
                updateConnectionStatus('disconnected');
            });

            socket.on('connect_error', (error) => {
                console.error('❌ Connection error:', error);
                updateConnectionStatus('error');
                showError('Connection error. Retrying...');
            });

            socket.on('newMessage', (data) => {
                console.log('Received new message:', data);
                if (data.roomId === currentRoom) {
                    appendMessage(data.message);
                }
                loadChatRooms(); // Refresh room list to update lastMessage
            });

            socket.on('messageSent', () => {
                document.getElementById('messageInput').value = '';
            });

            socket.on('error', (error) => {
                console.error('Socket error:', error);
                showError(error.message || 'An error occurred');
            });

            socket.on('typing', ({ userId, roomId }) => {
                if (roomId === currentRoom && userId !== currentUser._id) {
                    const chatArea = document.getElementById('chatArea');
                    const existingIndicator = document.getElementById('typingIndicator');
                    if (!existingIndicator) {
                        const typingIndicator = document.createElement('div');
                        typingIndicator.id = 'typingIndicator';
                        typingIndicator.className = 'text-gray-500 italic';
                        typingIndicator.textContent = 'Someone is typing...';
                        chatArea.appendChild(typingIndicator);
                        chatArea.scrollTop = chatArea.scrollHeight;
                    }
                }
            });

            socket.on('stopTyping', ({ roomId }) => {
                if (roomId === currentRoom) {
                    document.getElementById('typingIndicator')?.remove();
                }
            });
        }

        async function loadChatRooms() {
            try {
                const response = await fetch('/api/chat/userchats', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`Failed to load chat rooms: ${response.statusText}`);
                }

                const rooms = await response.json();
                console.log('Loaded chat rooms:', rooms);
                renderRoomList(rooms);

                // Auto-join the existing room if it exists and no room is selected
                if (rooms.length > 0 && !currentRoom) {
                    const existingRoom = rooms.find(room => room._id === '682a34fbf9824b353d1bcfa5');
                    if (existingRoom) {
                        joinRoom(existingRoom._id);
                    }
                }
            } catch (error) {
                console.error('Error loading chat rooms:', error);
                showError(error.message || 'Failed to load chat rooms');
            }
        }

        function renderRoomList(rooms) {
            const roomListEl = document.getElementById('roomList');
            if (!roomListEl) return;

            roomListEl.innerHTML = rooms.length === 0
                ? '<p class="text-gray-500 text-center py-4">No chat rooms available</p>'
                : '';

            rooms.forEach(room => {
                const roomEl = document.createElement('div');
                roomEl.className = `p-3 border-b border-gray-200 cursor-pointer hover:bg-gray-50 ${room._id === currentRoom ? 'bg-blue-100' : ''}`;
                roomEl.innerHTML = `
                    <div class="font-semibold">${room.roomName || 'Unnamed Room'}</div>
                    <div class="text-sm text-gray-600 truncate">${room.lastMessage?.content || 'No messages yet'}</div>
                    <div class="text-xs text-gray-400">${room.lastMessage ? new Date(room.lastMessage.createdAt).toLocaleString() : ''}</div>
                `;
                roomEl.addEventListener('click', () => joinRoom(room._id));
                roomListEl.appendChild(roomEl);
            });
        }

        async function joinRoom(roomId) {
            if (!roomId || roomId === currentRoom) return;
            try {
                if (currentRoom) {
                    socket.emit('leaveRoom', currentRoom);
                }
                currentRoom = roomId;
                if (socket?.connected) {
                    socket.emit('joinRoom', roomId);
                }
                const response = await fetch(`/api/chat/room/${roomId}`, {
                    headers: {
                        Authorization: `Bearer ${localStorage.getItem('token')}`,
                        'Content-Type': 'application/json',
                    },
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `Failed to load messages: ${response.statusText}`);
                }
                const messages = await response.json();
                console.log('Messages loaded for room:', roomId, messages);
                const chatArea = document.getElementById('chatArea');
                chatArea.innerHTML = '';
                if (messages.length === 0) {
                    chatArea.innerHTML = '<div class="text-gray-500 text-center py-4">No messages yet</div>';
                } else {
                    messages.forEach(appendMessage);
                }
                document.getElementById('messageForm').style.display = 'flex';
                loadChatRooms(); // Refresh room list
            } catch (error) {
                console.error('Error joining room:', error);
                showError(error.message || 'Failed to join room');
            }
        }

        async function initChatApp() {
            if (!await checkAuth()) return;

            const token = localStorage.getItem('token');
            initializeSocket(token);
            loadChatRooms();

            const createRoomModal = document.getElementById('createRoomModal');
            const createRoomForm = document.getElementById('createRoomForm');
            const messageForm = document.getElementById('messageForm');
            const messageInput = document.getElementById('messageInput');

            document.getElementById('createRoomBtn').addEventListener('click', () => {
                createRoomModal.classList.remove('hidden');
                createRoomModal.classList.add('flex');
            });

            document.getElementById('cancelCreateRoom').addEventListener('click', () => {
                createRoomModal.classList.add('hidden');
                createRoomModal.classList.remove('flex');
                createRoomForm.reset();
            });

            createRoomForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const roomName = document.getElementById('roomName').value;
                const shopId = document.getElementById('shopId').value;

                try {
                    const response = await fetch('/api/chat/newChat', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({ roomName, shopId })
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || 'Failed to create chat room');
                    }

                    const newRoom = await response.json();
                    createRoomModal.classList.add('hidden');
                    createRoomModal.classList.remove('flex');
                    createRoomForm.reset();
                    loadChatRooms();
                    joinRoom(newRoom.chatroom._id); // Auto-join the new room
                } catch (error) {
                    console.error('Error creating chat room:', error);
                    showError(error.message || 'Failed to create chat room');
                }
            });

            messageForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const content = messageInput.value.trim();
                if (!content || !currentRoom) return;

                try {
                    socket.emit('typing', currentRoom);
                    const response = await fetch('/api/chat/send', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({
                            roomId: currentRoom,
                            content,
                            senderType: 'User'
                        })
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || 'Failed to send message');
                    }

                    const message = await response.json();
                    // Append the message locally to ensure it appears immediately
                    appendMessage({
                        ...message,
                        sender: { _id: currentUser._id, username: currentUser.username },
                        createdAt: new Date(),
                    });
                    socket.emit('chatMessage', { roomId: currentRoom, message });
                    document.getElementById('messageInput').value = ''; // Clear input
                } catch (error) {
                    console.error('Error sending message:', error);
                    showError(error.message || 'Failed to send message');
                } finally {
                    socket.emit('stopTyping', currentRoom);
                }
            });

            let typingTimeout;
            messageInput.addEventListener('input', () => {
                if (messageInput.value.trim() && currentRoom) {
                    socket.emit('typing', currentRoom);
                    clearTimeout(typingTimeout);
                    typingTimeout = setTimeout(() => socket.emit('stopTyping', currentRoom), 2000);
                } else {
                    socket.emit('stopTyping', currentRoom);
                }
            });
        }

        document.addEventListener('DOMContentLoaded', initChatApp);
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden && socket && !socket.connected) {
                const token = localStorage.getItem('token');
                if (token) initializeSocket(token);
            }
        });
    </script>
</body>

</html>